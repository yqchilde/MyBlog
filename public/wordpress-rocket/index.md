# æ­£ç¡®é…ç½®rocket-nginxï¼ŒåŠ é€Ÿä½ çš„wordpress

<!--more-->

### 0x01 å‰æ

å‰ææ˜¯éœ€è¦å…ˆè·å¾—`wp-rocket`æ’ä»¶ï¼Œè¯¥æ’ä»¶æ˜¯æ”¶è´¹æ’ä»¶ï¼Œå¦‚æœæœ‰èƒ½åŠ›è¯·æ”¯æŒæ­£ç‰ˆï¼Œè¿™é‡Œä¸æä¾›ä¸‹è½½åœ°å€ï¼Œæ“…äºåˆ©ç”¨æœç´¢å¼•æ“æˆ–ä¸‡èƒ½çš„æŸå®ã€‚æœ¬æ–‡æ˜¯åŸºäºè‡ªå·±ç”¨å®å¡”é…ç½®rocket-nginxçš„æ•™ç¨‹ï¼Œå› ä¸ºç½‘ä¸Šç›®å‰æœåˆ°çš„æ‰€æœ‰é…ç½®éƒ½æ˜¯ç›´æ¥ç¿»è¯‘githubçš„README.md(ğŸ˜’)ï¼Œä¸è¿‡è¿˜æ˜¯æ¨èçœ‹æœ€æ–°çš„æ–‡æ¡£ï¼Œæ²¡å‡†å•¥æ—¶å€™å°±å˜åŠ¨äº†ï¼Œæ“ä½œæ­¥éª¤å¦‚ä¸‹

### 0x02 æ­£æ–‡

#### rocket-nginx

- ä»‹ç»ä¸€ä¸‹ï¼ˆç¿»è¯‘è¿‡æ¥ï¼‰ï¼š

Rocket-Nginxæ˜¯WordPressç¼“å­˜æ’ä»¶WP-Rocketçš„Nginxé…ç½®ã€‚å®ƒä½¿Nginxå¯ä»¥ç›´æ¥æä¾›ä»¥å‰ç¼“å­˜çš„æ–‡ä»¶ï¼Œè€Œæ— éœ€è°ƒç”¨WordPressæˆ–ä»»ä½•PHPã€‚å®ƒè¿˜ä¼šæ·»åŠ æ ‡é¢˜ä»¥ç¼“å­˜CSSï¼ŒJSå’Œåª’ä½“ï¼Œä»¥é€šè¿‡å‡å°‘å¯¹WebæœåŠ¡å™¨çš„è¯·æ±‚æ¥åˆ©ç”¨æµè§ˆå™¨çš„ç¼“å­˜ã€‚

- ç®€å•è¯´å°±æ˜¯**NGINXâ†’PHP-FPMâ†’PHPâ†’é™æ€æ–‡ä»¶** å˜æˆäº† **NGINXâ†’é™æ€æ–‡ä»¶**ï¼ˆé€šè¿‡ç›´æ¥æä¾›é™æ€é¡µé¢è€Œä¸åŠ è½½WordPressæˆ–PHPï¼Œå¯ä»¥ä½¿WP-Rocketæ›´å¿«ã€‚ï¼‰

- githubåœ°å€ï¼š[rocket-nginx](https://github.com/SatelliteWP/rocket-nginx)

#### ç¦æ­¢WPå®šæ—¶ä»»åŠ¡

åœ¨`wp-config`è¿™ä¸ªæ–‡ä»¶é‡Œæ·»åŠ ä¸€è¡Œä»£ç ï¼Œä½œç”¨æ˜¯ä¸ºäº†ç¦æ­¢WPè‡ªå¸¦çš„CRONå®šæ—¶ä»»åŠ¡

 `define('DISABLE_WP_CRON', true);`

#### æ·»åŠ æ–°çš„å®šæ—¶ä»»åŠ¡

ä»¥ä¸‹ä¸‰ç§å®šæ—¶ä»»åŠ¡ä»£ç ä»»ä¸€ä¸ªå°±è¡Œï¼Œè®°å¾—å°†websiteæ¢æˆè‡ªå·±çš„ç½‘å€

```shell
*/15 * * * * wget -q -O - http://www.website.com/wp-cron.php?doing_wp_cron &>/dev/null

or

*/15 * * * * curl http://www.website.com/wp-cron.php?doing_wp_cron &>/dev/null

or

*/15 * * * * cd /home/user/public_html; php wp-cron.php &>/dev/null
```

- åœ¨SSHæ·»åŠ å®šæ—¶ä»»åŠ¡ï¼Œå…ˆå»äº†è§£`Crontab`çŸ¥è¯†ï¼Œ[ç‚¹è¿™é‡ŒæŸ¥çœ‹](https://www.runoob.com/w3cnote/linux-crontab-tasks.html)

- æœ‰å®å¡”é¢æ¿çš„å¯ä»¥ç›´æ¥åœ¨å®å¡”ä¸­æ·»åŠ å®šæ—¶ä»»åŠ¡ï¼Œé‚£å°±ç®€å•äº†

![image-20200308183831086](https://pic.yqqy.top/blog/20200308183833.png?imageMogr2/format/webp/interlace/1 "å®šæ—¶ä»»åŠ¡")

#### æ‹‰å–rocket-nginxåˆ°nginxç›®å½•

- åœ¨SSHé‡Œé¢è¿›å…¥åˆ°nginxçš„ç›®å½•ï¼Œä»¥å®å¡”ä¸ºä¾‹ï¼ˆ/www/server/nginxï¼‰`cd /www/server/nginx`

- æ‹‰å–ä»£ç  `git clone https://github.com/satellitewp/rocket-nginx.git`

- ä»2.0ç‰ˆå¼€å§‹ï¼Œå¿…é¡»ç”Ÿæˆé…ç½®ã€‚è¦ç”Ÿæˆé»˜è®¤é…ç½®ï¼Œå¿…é¡»é‡å‘½åç¦ç”¨çš„iniæ–‡ä»¶å¹¶è¿è¡Œé…ç½®è§£æå™¨ï¼š

  ```shell
  cd rocket-nginx
  cp rocket-nginx.ini.disabled rocket-nginx.ini
  php rocket-parser.php
  ```

- è¿è¡Œä¹‹åå°±ä¼šåœ¨`rocket-nginx`ç›®å½•ç”Ÿæˆä¸€ä¸ª`default.conf`æ–‡ä»¶ï¼Œæ˜¯æ ¹æ®`rocket-nginx.ini`å¯¹åº”è§£æçš„ï¼Œæ‰€ä»¥å¯ä»¥çœ‹çœ‹ç›¸åº”é…ç½®

#### åœ¨nginxé…ç½®æ–‡æ¡£å¯¼å…¥

- åœ¨å¯¹åº”ç½‘ç«™çš„`nginx`é…ç½®æ–‡æ¡£ä¸­`server`éƒ¨åˆ†å¯¼å…¥

  ```nginx
  server {
      ...
      # Rocket-Nginx configuration
  	include /www/server/nginx/rocket-nginx/default.conf;
      ...
  }
  ```

- é…ç½®å®Œè¦å…ˆæµ‹è¯•æ˜¯å¦é…ç½®å¯è¡Œ `nginx -t`
- é…ç½®å¯è¡Œè®°å¾—é‡å¯nginx `service nginx reload`

#### æµ‹è¯•æ˜¯å¦ç”Ÿæ•ˆ

- åœ¨`rocket-nginx.ini` æ–‡ä»¶ä¸­å°†`debug`è®¾ç½®æˆtrueï¼Œè¿™æ ·å°±å¯ä»¥çœ‹åˆ°åœ¨è¯·æ±‚çš„headeré‡Œé¢æœ‰`X-Rocket-Nginx`å¼€å¤´çš„å†…å®¹

  ```http
  X-Rocket-Nginx-Serving-Staticï¼šé…ç½®æ˜¯å¦ç›´æ¥æä¾›äº†ç¼“å­˜æ–‡ä»¶ï¼ˆæ˜¯å¦ç»•è¿‡WordPressï¼‰ï¼šæ˜¯æˆ–å¦
  X-Rocket-Nginx-Reasonï¼šæ³¨æ˜äº†ä¸ºä»€ä¹ˆå¯ç”¨çš„åŸå› ï¼Œå¦‚æœå¯ç”¨æˆåŠŸè¿”å›è·¯å¾„ï¼Œå¤±è´¥è¿”å›åŸå› 
  X-Rocket-Nginx-Fileï¼šä¸ç®¡æ˜¯å¦å¯ç”¨æˆåŠŸï¼Œè¿™é‡Œå±•ç¤ºä¸€ä¸‹ä»£ç†çš„è·¯å¾„ï¼Œæ–¹ä¾¿æ‹é”™
  ```

### 0x03 æ³¨æ„

- æç¤ºï¼šæ¯æ¬¡æ›´æ”¹äº†`rocket-nginx.ini`å°±è¦åˆ©ç”¨`php rocket-parser.php` å‘½ä»¤è§£æ

- è®°å¾—å…³é—­`wp-rocket`æ’ä»¶ä¸­çš„å¯¹ç§»åŠ¨ç«¯å•ç‹¬ç¼“å­˜åŠŸèƒ½ï¼Œï¼ˆé™¤éä½ çš„ä¸»é¢˜å¼€å‘äº†ä¸¤ç«¯ï¼‰æˆ‘æƒ³ç°åœ¨çš„ä¸»é¢˜éƒ½æ˜¯å“åº”å¼çš„ä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜

- å¦‚æœç«™ç‚¹æ˜¯`https`å¹¶ä¸”åœ¨headerä¸­æ˜¾ç¤ºå¦‚ä¸‹å†…å®¹ï¼Œå³ç»“å°¾ä¸€ç›´æ˜¯`/index.html`ï¼Œé‚£å°±è¯´æ˜å¯èƒ½æ˜¯ä½ çš„nginxé…ç½®æ–‡ä»¶çš„é—®é¢˜ï¼Œéœ€è¦ä»è‡ªå·±çš„æ–‡æ¡£ä¸‹æ‰‹

  ```http
  X-Rocket-Nginx-Serving-Staticï¼šNO
  X-Rocket-Nginx-Fileï¼š... /index.html
  ```

- æ­£ç¡®çš„è·¯å¾„ç»“å°¾åº”è¯¥æ˜¯ `index-https.html_gzip`ï¼Œè¿™æ˜¯`https`ç«™ç‚¹çš„æƒ…å†µ

### 0x04 æ•ˆæœ

åœ¨æ²¡æœ‰åš`nginx`ä¼˜åŒ–æ—¶ï¼Œå³ä½¿ç”¨äº†`wp-rocket`æ’ä»¶ä¹Ÿæ˜¯ä¸¤ä¸ªBï¼Œç°åœ¨æ˜æ˜¾æœ‰å˜åŒ–ï¼Œå› ä¸ºæœ¬ä¸»é¢˜æ˜¯å›¾æ–‡å¼çš„ï¼Œå¦‚æœä½ çš„ä¸»é¢˜ä¸æ€ä¹ˆç”¨å›¾ç‰‡ï¼Œé‚£ä¹ˆæ•ˆæœä¼šæ›´ä¸ºæ˜¾è‘—ã€‚

![image-20200308190851632](https://pic.yqqy.top/blog/20200308190854.png?imageMogr2/format/webp/interlace/1 "é€Ÿåº¦æµ‹è¯•")
